# Database Migrations with Alembic

This directory contains database migration scripts managed by [Alembic](https://alembic.sqlalchemy.org/).

## Setup

Alembic is already configured to work with our async SQLAlchemy models. The configuration:

- Reads database URL from `app.config.settings`
- Automatically imports all models from `app.models`
- Converts async database URLs to sync for migration execution
- Supports both SQLite (dev) and PostgreSQL (production)

## Common Commands

All commands should be run from the `backend/` directory.

### View Current Migration Version

```bash
alembic current
```

### Create a New Migration

After modifying models in `app/models/`, generate a migration:

```bash
alembic revision --autogenerate -m "Description of changes"
```

### Apply Migrations

Upgrade to the latest version:

```bash
alembic upgrade head
```

Upgrade to a specific version:

```bash
alembic revision_id
```

### Rollback Migrations

Downgrade one version:

```bash
alembic downgrade -1
```

Downgrade to base (remove all migrations):

```bash
alembic downgrade base
```

### View Migration History

```bash
alembic history --verbose
```

### Show Current Schema State

```bash
alembic current
```

## Migration Files

Migration files are stored in `alembic/versions/`. Each file contains:

- `upgrade()`: Function to apply the migration
- `downgrade()`: Function to rollback the migration

**Important**: Always review autogenerated migrations before committing them. Alembic may not detect all changes correctly.

## Database URL Configuration

The database URL is configured in `app/config.py`:

- **Development**: `sqlite+aiosqlite:///./basketball_analyzer.db`
- **Production**: Set via environment variable `DATABASE_URL`

The `env.py` file automatically converts async URLs (`sqlite+aiosqlite`, `postgresql+asyncpg`) to sync URLs (`sqlite`, `postgresql`) for Alembic compatibility.

## Workflow

1. Modify SQLAlchemy models in `app/models/`
2. Generate migration: `alembic revision --autogenerate -m "Add new field"`
3. Review the generated migration file in `alembic/versions/`
4. Test the migration:
   - `alembic upgrade head` (apply)
   - `alembic downgrade -1` (rollback)
   - `alembic upgrade head` (apply again)
5. Commit both the model changes and migration file
6. In production, run `alembic upgrade head` to apply migrations

## Troubleshooting

### "Target database is not up to date"

This means you need to run migrations:

```bash
alembic upgrade head
```

### "Can't locate revision identified by"

The database has a migration version that doesn't exist in your code. Either:

1. Pull latest migrations from git
2. Reset database and rerun migrations

### Tables already exist

If you're starting fresh:

```bash
rm basketball_analyzer.db*
alembic upgrade head
```

For existing databases with manual schema creation:

```bash
alembic stamp head
```

This marks the database as up-to-date without running migrations.
